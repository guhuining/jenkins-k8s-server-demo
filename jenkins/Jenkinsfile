pipeline {
	agent any

	environment {
		IMAGE_NAME = 'jenkins-demo'
		DOCKER_REGISTRY = "${env.DOCKER_REGISTRY}"
		DOCKER_REGISTRY_CREDENTIALS = "${env.DOCKER_REGISTRY_CREDENTIALS}"
		KUBECONFIG = "${env.KUBECONFIG}"
	}

	stages {
		stage('Build Maven') {
			agent {
				docker {
					image 'maven:3.9.11-eclipse-temurin-21-noble'
					args '-v /root/.m2:/root/.m2'
				}
			}
			steps {
				sh 'mvn -B -DskipTests clean package'
				stash name: 'app-jar', includes: 'target/*.jar'
			}
		}



		stage('Build Docker Image') {
			steps {
				unstash 'app-jar'
				script {
					def appImage = docker.build("${IMAGE_NAME}:${BUILD_NUMBER}")
					appImage.tag("${IMAGE_NAME}:latest")
				}
			}
		}


	}
}