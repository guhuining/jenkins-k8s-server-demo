pipeline {
	agent any

	environment {
		IMAGE_NAME = 'jenkins-demo'
		DOCKER_REGISTRY = "${env.DOCKER_REGISTRY}"
		DOCKER_REGISTRY_CREDENTIALS = "${env.DOCKER_REGISTRY_CREDENTIALS}"
		KUBECONFIG = "${env.KUBECONFIG}"
	}

	stages {
		stage('Build Maven') {
			agent {
				docker {
					image 'maven:3.9.11-eclipse-temurin-21-noble'
					args '-v /root/.m2:/root/.m2'
				}
			}
			steps {
				sh 'mvn -B -DskipTests clean package'
				stash name: 'app-jar', includes: 'target/*.jar'
			}
		}



		stage('Build Docker Image') {
			steps {
				unstash 'app-jar'
				script {
					def appImage = docker.build("${DOCKER_REGISTRY_USERNAME}/${IMAGE_NAME}:${BUILD_NUMBER}")
					appImage.tag "latest"
				}
			}
		}

		stage('Push Docker Image') {
			steps {
				script {
					docker.withRegistry("${DOCKER_REGISTRY}", "${DOCKER_REGISTRY_CREDENTIALS}") {
						docker.image("${DOCKER_REGISTRY_USERNAME}/${IMAGE_NAME}:${BUILD_NUMBER}").push()
						docker.image("${DOCKER_REGISTRY_USERNAME}/${IMAGE_NAME}:latest").push()
					}
				}
			}
		}

		stage('Deploy to Kubernetes') {
			agent {
				docker {
					image 'maven:3.9.11-eclipse-temurin-21-noble'
					args '-v /root/.m2:/root/.m2'
				}
			}
			steps {
				script {
					withCredentials([file(credentialsId: "${KUBECONFIG_CREDENTIALS_FILE_ID}", variable: 'KUBECONFIG')]) {
						sh """
								kubectl --kubeconfig=${KUBECONFIG} set image deployment/deployment-jenkins-demo \
									${IMAGE_NAME}=${DOCKER_REGISTRY}/${DOCKER_REGISTRY_USERNAME}/${IMAGE_NAME}:${BUILD_NUMBER}
								kubectl --kubeconfig=${KUBECONFIG} rollout status deployment/deployment-jenkins-demo
							"""
					}
				}
			}
		}
	}
}